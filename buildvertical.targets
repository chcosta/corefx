<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" InitialTargets="CheckForBuildTools" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="FindBestConfiguration" AssemblyFile="$(CoreFxToolsTaskDir)CoreFx.Tools.dll"/>

  <Import Project="buildvertical.props" />

   <!-- Gather the projects used for building a vertical (all the src\proj files ) --> 
   <Target Name="GatherProjectsForVerticalBuild" 
           BeforeTargets="DetermineBuildVerticalProjects"> 
     <ItemGroup> 
       <Project Remove="@(Project)" /> 
       <ReferenceProject Include="$(ProjectDir)src/ref.builds" />
       <Project Include="$(ProjectDir)**/src/*.csproj" /> 
       <Project Include="$(ProjectDir)**/src/*.vbproj" />       
     </ItemGroup> 
     <Message Text="Projects: @(Project)" Importance="Low" /> 
   </Target> 

  <!-- Add vertical projects to the project group for BuildAllProjects -->
  <Target Name="AddVerticalProjects"
          DependsOnTargets="DetermineProjectsConfiguration"
          BeforeTargets="BuildAllProjects">
    <ItemGroup>
      <OmitProject Include="%(Project.Identity)" Condition="'%(Project.OmitReason)' != ''">
        <OmitReason>%(Project.OmitReason)</OmitReason>
      </OmitProject>
      <Project Remove="@(OmitProject)" />
    </ItemGroup>
  </Target>

  <!-- The initial shaking target for trimming down applicable projects for specified vertical -->
  <Target Name="DetermineProjectsConfiguration"
          Inputs="%(Project.Identity)"
          Outputs="fake"
          Returns="@(Project)"
          DependsOnTargets="TrimUnconvertedProjects"
          BeforeTargets="BuildAllProjects">
    <PropertyGroup>
      <_VerticalProject>%(Project.Identity)</_VerticalProject>
      <_VerticalProjectName>%(Project.FullPath)</_VerticalProjectName>
      <_OmitReason>%(Project.OmitReason)</_OmitReason>
    </PropertyGroup>

    <!-- Clear the VerticalTargets item -->
    <ItemGroup><VerticalTargets Remove="@(VerticalTargets)" /></ItemGroup>
    <MSBuild Targets="FindBestConfiguration"
             Projects="$(_VerticalProject)"
             Condition="'$(_OmitReason)' == ''">
      <Output TaskParameter="TargetOutputs"
              ItemName="VerticalTargets" />
    </MSBuild>

    <PropertyGroup>
      <_SelectedOSGroup>%(VerticalTargets.OSGroup)</_SelectedOSGroup>
      <_SelectedTargetGroup>%(VerticalTargets.TargetGroup)</_SelectedTargetGroup>
    </PropertyGroup>

    <Message Importance="Low" Text="Adding '$(_VerticalProject)', SelectedTargetGroup: $(_SelectedTargetGroup), SelectedOSGroup: $(_SelectedOSGroup)" />
    <ItemGroup>
      <Project Remove="$(_VerticalProject)" />
      <Project Condition="'$(_SelectedTargetGroup)' != '' and '$(_SelectedOSGroup)' != ''" Include="$(_VerticalProject)">  
        <TargetGroup>$(_SelectedTargetGroup)</TargetGroup>
        <OSGroup>$(_SelectedOSGroup)</OSGroup>
      </Project>
      <Project Condition="'$(_SelectedTargetGroup)' == ''" Include="$(_VerticalProject)">
        <OmitReason>No applicable TargetGroup</OmitReason>
      </Project>
      <Project Condition="'$(_SelectedOSGroup)' == ''" Include="$(_VerticalProject)">
        <OmitReason>No applicable OSGroup</OmitReason>
      </Project>
      <Project Condition="'$(_OmitReason)' != ''">
        <OmitReason>$(_OmitReason)</OmitReason>
      </Project>
    </ItemGroup>
  </Target>

  <!-- For the current project, target which determines compatibility for targets -->
  <Target Name="FindBestConfiguration"
          Returns="@(VerticalTargets)"
          BeforeTargets="BeforeResolveReferences">
    
    <MSBuild Targets="GetBuildConfigurations"
             Projects="$(MSBuildProjectFullPath)"
             Properties="DefaultTargetGroup=$(_DefaultTargetGroup)">
      <Output TaskParameter="TargetOutputs"
              PropertyName="BuildConfigurations" />
    </MSBuild>

    <Message Text="$(MSBuildProjectFullPath) - BuildConfigurations: $(BuildConfigurations)" Importance="Low" />

    <Message Importance="Normal" Condition="'$(BuildConfigurations)' == ''" Text="Project '$(MSBuildProjectFullPath)' does not specify the BuildConfigurations property." />

     <!-- Clear the VerticalTargets item -->
    <ItemGroup><VerticalTargets Remove="@(VerticalTargets)" /></ItemGroup>
    <FindBestConfiguration Properties="@(Property)"
                           PropertyValues="@(PropertyValue)"
                           BuildConfigurations="$(BuildConfigurations)"
                           BuildConfiguration="$(BuildConfiguration)" 
                           Condition="'$(BuildConfigurations)' != ''"
                           ContinueOnError="true">
      <Output TaskParameter="BestConfiguration" ItemName="VerticalTargets" />                          
    </FindBestConfiguration>  

    <PropertyGroup>
      <_SelectedTargetGroup>%(VerticalTargets.TargetGroup)</_SelectedTargetGroup>
      <_SelectedOSGroup>%(VerticalTargets.OSGroup)</_SelectedOSGroup>
      <TargetGroup>$(_SelectedTargetGroup)</TargetGroup>
      <OSGroup>$(_SelectedOSGroup)</OSGroup>
      <NuGetTargetMoniker Condition="'%(TargetGroups.Identity)' == '$(_SelectedTargetGroup)'">%(TargetGroups.NuGetTargetMoniker)</NuGetTargetMoniker>
    </PropertyGroup>

    <Message Importance="Low" Text="FindBestConfigurations: $(MSBuildProjectFullPath) - TargetGroup: $(TargetGroup) OSGroup: $(OSGroup) DefaultTargetGroup: $(_DefaultTargetGroup)" />    
  </Target>

  <!-- Given a project reference, determine compatible target group and add it to the project reference metadata -->
  <Target Name="AnnotateVerticalProjectReferences"
          Inputs="%(ProjectReference.Identity)"
          Outputs="fake"
          BeforeTargets="BeforeResolveReferences">
    <PropertyGroup>
      <_ProjectReferenceToAnnotate>%(ProjectReference.Identity)</_ProjectReferenceToAnnotate>
    </PropertyGroup>

    <!-- Get the project reference's supported target groups and os groups -->
    <MSBuild Targets="GetBuildConfigurations"
             Projects="$(_ProjectReferenceToAnnotate)">
      <Output TaskParameter="TargetOutputs"
              PropertyName="BuildConfigurations" />
    </MSBuild>

<!-->    <Error Condition="!$(_ProjectReferenceToAnnotate.Contains('/ref/')) and !$(_ProjectReferenceToAnnotate.Contains('\\ref\\')) and '$(BuildConfigurations)' == ''" Text=" ProjectReference '$(_ProjectReferenceToAnnotate)' does not support any vertical groups." ContinueOnError="true" /> -->

     <!-- Clear the VerticalTargets item -->
    <ItemGroup><VerticalTargets Remove="@(VerticalTargets)" /></ItemGroup>
    <FindBestConfiguration Properties="@(Property)"
                           PropertyValues="@(PropertyValue)"
                           BuildConfigurations="$(BuildConfigurations)"
                           BuildConfiguration="$(BuildConfiguration)" 
                           Condition="'$(BuildConfigurations)' != ''">
      <Output TaskParameter="BestConfiguration" ItemName="VerticalTargets" />                          
    </FindBestConfiguration>  

    <PropertyGroup>
      <_SelectedTargetGroup>%(VerticalTargets.TargetGroup)</_SelectedTargetGroup>
      <_SelectedOSGroup>%(VerticalTargets.OSGroup)</_SelectedOSGroup>
    </PropertyGroup>
    <Message Importance="Low" Text="Annotate ProjectReference - $(MSBuildProjectFullPath) - $(_ProjectReferenceToAnnotate) ($(_SelectedTargetGroup) === $(_DefaultTargetGroup),  $(_SelectedOSGroup)) Supports: $(BuildConfigurations)" />

    <Error ContinueOnError="true" Condition="$(_ProjectReferenceToAnnotate.EndsWith('.builds')) or $(_ProjectReferenceToAnnotate.EndsWith('.pkgproj'))" Text="Warning: $(MSBuildProjectFullPath) contains ProjectReference to a multi-build project, '$(_ProjectReferenceToAnnotate)'" />
    <!-- Annotate the ProjectReference -->
    <ItemGroup>
        <ProjectReference Condition="'%(ProjectReference.OutputItemType)' != 'ResolvedMatchingContract'">
          <TargetGroup Condition="'%(ProjectReference.TargetGroup)' == ''">$(_SelectedTargetGroup)</TargetGroup>
          <OSGroup Condition="'%(ProjectReference.OSGroup)' == ''">$(_SelectedOSGroup)</OSGroup>
        </ProjectReference>
    </ItemGroup>
  </Target>

  <!-- Used to retrieve properties from projects (via project evaluation) -->
  <Target Name="GetBuildConfigurations"
          Returns="$(BuildConfigurations)" />

  <!-- Summary message after BuildAllProjects completes -->
  <Target Name="PrintVerticalSummary"
          AfterTargets="BuildAllProjects">
    <Message Text="Summary" Importance="High" />
    <Message Text=" Libraries contributing to $(BuildConfiguration) ($(BaseOutputPath)):" Importance="High" />
    <Message Text="   %(Project.Identity) (%(Project.TargetGroup) - %(Project.OSGroup))" Importance="High" />
    <Message Text=" Libraries ommitted:" Importance="High" />
    <Message Text="   %(OmitProject.Identity) because '%(OmitProject.OmitReason)'" Importance="High" />
  </Target>

  <!-- Temporary target which intentionally omits projects that don't specify the "BuildConfigurations" property. -->
  <Target Name="TrimUnconvertedProjects"
          Inputs="%(Project.Identity)"
          Outputs="fake"
          DependsOnTargets="GatherProjectsForVerticalBuild">
    <PropertyGroup>
      <_ProjectToTestForTrim>%(Project.Identity)</_ProjectToTestForTrim>
      <_ProjectToTestForTrimDirectory>%(Project.RootDir)%(Project.Directory)/</_ProjectToTestForTrimDirectory>
    </PropertyGroup>
    <MSBuild Targets="GetBuildConfigurations"
             Projects="$(_ProjectToTestForTrim)">
      <Output TaskParameter="TargetOutputs"
              PropertyName="BuildConfigurations" />
    </MSBuild>

    <ItemGroup Condition="'$(BuildConfigurations)' == ''">
      <Project>
        <OmitReason>%(Project.OmitReason) No project configurations specified.</OmitReason>
      </Project>
    </ItemGroup>

    <PropertyGroup>
      <_OmitReason />
    </PropertyGroup>
    <ReadLinesFromFile File="$(_ProjectToTestForTrimDirectory)omit.txt"
                       Condition="Exists('$(_ProjectToTestForTrimDirectory)omit.txt')">
      <Output TaskParameter="Lines"
              ItemName="ItemsFromFile" />
    </ReadLinesFromFile>
    <PropertyGroup>
      <OmitReason>@(ItemsFromFile)</OmitReason>
    </PropertyGroup>

    <ItemGroup Condition="'$(OmitReason)' != ''">
      <Project>
        <OmitReason>%(Project.OmitReason) $(OmitReason)</OmitReason>
      </Project>
    </ItemGroup>  
  </Target>          
</Project>