<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="FindBestConfiguration" AssemblyFile="$(CoreFxToolsTaskDir)CoreFx.Tools.dll"/>

  <Import Project="buildvertical.props" />

  <PropertyGroup>
    <ImportedBuildVerticalTargets>true</ImportedBuildVerticalTargets>
  </PropertyGroup>
  
  <!-- Add vertical projects to the project group for BuildAllProjects -->
  <Target Name="AddVerticalProjects"
          Inputs="$(MSBuildProjectFullPath)"
          Outputs="fake"
          DependsOnTargets="DetermineProjectsConfiguration"
          BeforeTargets="AnnotateProjectsWithConfiguration">
    <ItemGroup>
      <OmitProject Include="$(MSBuildProjectFullPath)" Condition="'$(OmitReason)' != ''">
        <OmitReason>$(OmitReason)</OmitReason>
      </OmitProject>
      <Project Remove="@(OmitProject)" />
    </ItemGroup>
  </Target>

 <Target Name="AnnotateProjectsWithConfiguration" 
         Returns="@(ProjectWithConfiguration)" > 
    <PropertyGroup>
      <_ProjectName>$(MSBuildProjectFullPath)</_ProjectName>
    </PropertyGroup>
    <Message Importance="Low" Text="AnnotateProjectsWithConfiguration: $(_ProjectName) - BestC: $(_BestConfiguration)" />
    <ItemGroup> 
       <ProjectWithConfiguration Include="$(_ProjectName)" > 
        <AdditionalProperties Condition="'$(_BestConfiguration)' != ''">Configuration=$(_BestConfiguration)</AdditionalProperties>
        <UndefineProperties Condition="'$(_BestConfiguration)' == ''">Configuration</UndefineProperties>
       </ProjectWithConfiguration>
     </ItemGroup> 
  </Target>

  <!-- The initial shaking target for trimming down applicable projects for specified vertical -->
  <Target Name="DetermineProjectsConfiguration"
          Inputs="$(MSBuildProjectFullPath)"
          Outputs="fake"
          Returns="@(Project)"
          BeforeTargets="AnnotateProjectsWithConfiguration">
    <PropertyGroup>
      <_VerticalProject>$(MSBuildProjectFullPath)</_VerticalProject>
    </PropertyGroup>

    <!-- Clear the _Configuration item -->
    <ItemGroup><_Configuration Remove="@(_Configuration)" /></ItemGroup>
    <MSBuild Targets="FindBestConfiguration"
             Projects="$(_VerticalProject)">
      <Output TaskParameter="TargetOutputs"
              ItemName="_Configuration" />
    </MSBuild>

    <PropertyGroup>
      <_BestConfiguration>%(_Configuration.Identity)</_BestConfiguration>
      <_KeepProject>%(_Configuration.NoBuildConfigurations)</_KeepProject>
    </PropertyGroup>

    <Message Importance="Low" Text="$(MSBuildProjectFullPath) Adding $(_VerticalProject)  _Configuration: $(_BestConfiguration)" />
    <PropertyGroup Condition="'$(_KeepProject)' != 'true'">
       <OmitReason Condition="'$(_BestConfiguration)' == ''">No applicable Configuration</OmitReason>
    </PropertyGroup>
  </Target>

  <!-- For the current project, target which determines compatibility for targets -->
  <Target Name="FindBestConfiguration"
          Returns="@(_Configuration)"
          BeforeTargets="BeforeResolveReferences">
    
    <Message Importance="Low" Text="FindBestConfiguration: $(MSBuildProjectFullPath) - $(BuildConfigurationImportFile)" />
    <MSBuild Targets="GetBuildConfigurations"
             Projects="$(MSBuildProjectFullPath)">
      <Output TaskParameter="TargetOutputs"
              PropertyName="BuildConfigurations" />
    </MSBuild>

    <Message Importance="Low" Text="$(MSBuildProjectFullPath) - BuildConfigurations: $(BuildConfigurations)" />

    <Message Importance="Normal" Condition="'$(BuildConfigurations)' == ''" Text="Project '$(MSBuildProjectFullPath)' does not specify the BuildConfigurations property." />

     <!-- Clear the VerticalTargets item -->
    <ItemGroup><_Configuration Remove="@(_Configuration)" /></ItemGroup>
    <FindBestConfiguration Properties="@(Property)"
                           PropertyValues="@(PropertyValue)"
                           BuildConfigurations="$(BuildConfigurations)"
                           BuildConfiguration="$(BuildConfiguration)" 
                           Condition="'$(BuildConfigurations)' != ''"
                           ContinueOnError="true">
      <Output TaskParameter="BestConfiguration" ItemName="_Configuration" />                          
    </FindBestConfiguration>  

    <ItemGroup Condition="'$(BuildConfigurations)' == ''">
      <VerticalTargets Include="$(MSBuildProjectFullPath)">
        <NoBuildConfigurations>true</NoBuildConfigurations>
      </VerticalTargets>
    </ItemGroup>
  </Target>

  <!-- Given a project reference, determine compatible target group and add it to the project reference metadata -->
  <Target Name="AnnotateVerticalProjectReferences"
          Inputs="%(ProjectReference.Identity)"
          Outputs="fake"
          BeforeTargets="BeforeResolveReferences">
    <Message Importance="Low" Text="AnnotateVerticalProjectReferences: %(ProjectReference.Identity)" />
    <PropertyGroup>
      <_ProjectReferenceToAnnotate>%(ProjectReference.Identity)</_ProjectReferenceToAnnotate>
    </PropertyGroup>

    <!-- Get the project reference's supported target groups and os groups -->
    <MSBuild Targets="GetBuildConfigurations"
             Projects="$(_ProjectReferenceToAnnotate)">
      <Output TaskParameter="TargetOutputs"
              PropertyName="BuildConfigurations" />
    </MSBuild>

<!-->    <Error Condition="!$(_ProjectReferenceToAnnotate.Contains('/ref/')) and !$(_ProjectReferenceToAnnotate.Contains('\\ref\\')) and '$(BuildConfigurations)' == ''" Text=" ProjectReference '$(_ProjectReferenceToAnnotate)' does not support any vertical groups." ContinueOnError="true" /> -->

     <!-- Clear the VerticalTargets item -->
    <ItemGroup><_Configuration Remove="@(_Configuration)" /></ItemGroup>
    <FindBestConfiguration Properties="@(Property)"
                           PropertyValues="@(PropertyValue)"
                           BuildConfigurations="$(BuildConfigurations)"
                           BuildConfiguration="$(BuildConfiguration)" 
                           Condition="'$(BuildConfigurations)' != ''">
      <Output TaskParameter="BestConfiguration" ItemName="_Configuration" />                          
    </FindBestConfiguration>  

    <PropertyGroup>
      <_BestConfiguration>%(_Configuration.Identity)</_BestConfiguration>
      <_AdditionalProperties Condition="'$(_BestConfiguration)' != ''">Configuration=$(_BestConfiguration);$(_AdditionalProperties)</_AdditionalProperties>
    </PropertyGroup>
    <Message Importance="Normal" Text="Annotate ProjectReference - $(MSBuildProjectFullPath) - $(_ProjectReferenceToAnnotate) $(_BestConfiguration) Supports: $(BuildConfigurations)" />

    <Error ContinueOnError="true" Condition="$(_ProjectReferenceToAnnotate.EndsWith('.builds')) or $(_ProjectReferenceToAnnotate.EndsWith('.pkgproj'))" Text="Warning: $(MSBuildProjectFullPath) contains ProjectReference to a multi-build project, '$(_ProjectReferenceToAnnotate)'" />
    <!-- Annotate the ProjectReference -->
    <ItemGroup>
        <ProjectReference Condition="'%(ProjectReference.Identity)' == '$(_ProjectReferenceToAnnotate)' and '$(BuildConfigurations)' != '' and '%(ProjectReference.OutputItemTime)' != 'ResolvedMatchingContract'">
          <Configuration>$(_BestConfiguration)</Configuration>
          <AdditionalProperties>$(_AdditionalProperties);%(ProjectReference.AdditionalProperties)</AdditionalProperties>
        </ProjectReference>

        <ProjectReference Condition="'%(ProjectReference.Identity)' == '$(_ProjectReferenceToAnnotate)' and '$(_BestConfiguration)' == ''">
          <UndefineProperties>Configuration;%(ProjectReference.UndefineProperties)</UndefineProperties>
        </ProjectReference>
    </ItemGroup>
  </Target>

  <!-- Used to retrieve properties from projects (via project evaluation) -->
  <Target Name="GetBuildConfigurations"
          Returns="$(BuildConfigurations)"
          BeforeTargets="BeforeResolveReferences" />
</Project>